{% extends 'base.html' %}

{% block title %}é¦–é¡µ - é‡å­å¤ªç©ºæ€æ”»ç•¥ç«™{% endblock %}

{% block extra_css %}
<style>
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    /* æœç´¢æ æ ·å¼ä¼˜åŒ– */
    .search-container {
        animation: fadeIn 0.6s ease-out;
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .search-form {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto auto;
        gap: 1rem;
        align-items: end;
    }
    
    @media (max-width: 768px) {
        .search-form {
            grid-template-columns: 1fr;
        }
    }
    
    .search-input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 1rem;
        align-items: end;
    }
    
    @media (max-width: 576px) {
        .search-input-group {
            grid-template-columns: 1fr;
        }
    }
    
    .search-input {
        position: relative;
    }
    
    .search-input input:focus + .search-icon {
        color: var(--primary-color);
    }
    
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        transition: color 0.3s ease;
    }
    
    .search-input input {
        padding-left: 2.5rem !important;
    }
    
    .search-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* åˆ†ç±»ç­›é€‰æ ·å¼ä¼˜åŒ– */
    .category-filter {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--border-radius);
        overflow-x: auto;
    }
    
    .category-btn {
        flex-shrink: 0;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        background: var(--secondary-color);
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .category-btn:hover:not(.active) {
        background: #5dade2;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .category-btn.active {
        background: var(--primary-color);
        box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }
    
    /* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ä¼˜åŒ– */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stats-card {
        background: linear-gradient(135deg, var(--primary-color), #5dade2);
        color: white;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    /* æ”»ç•¥å¡ç‰‡æ ·å¼ä¼˜åŒ– */
    .guide-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .guide-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.4s ease-out;
    }
    
    .guide-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }
    
    .guide-title {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    
    .guide-title a {
        color: #2c3e50;
        text-decoration: none;
        transition: color 0.3s ease;
    }
    
    .guide-title a:hover {
        color: var(--primary-color);
    }
    
    .guide-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    
    .guide-meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .guide-content {
        margin-bottom: 1rem;
        line-height: 1.6;
        color: #34495e;
    }
    
    .guide-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .tag {
        background: var(--tag-bg-color);
        color: var(--tag-color);
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .tag:hover {
        background: var(--primary-color);
        color: white;
    }
    
    /* åˆ†é¡µæ ·å¼ä¼˜åŒ– */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }
    
    .pagination .btn {
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0 12px;
        transition: all 0.3s ease;
    }
    
    .pagination .btn:hover:not(.active) {
        background: var(--secondary-color);
        color: white;
    }
    
    .pagination .btn.active {
        background: var(--primary-color);
        color: white;
        font-weight: bold;
    }
    
    /* ç©ºçŠ¶æ€æ ·å¼ä¼˜åŒ– */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        animation: fadeIn 0.6s ease-out;
    }
    
    .empty-state-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
        opacity: 0.6;
    }
    
    .empty-state-title {
        margin-bottom: 1rem;
        color: #2c3e50;
    }
    
    .empty-state-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
        margin-top: 2rem;
    }
    
    @media (min-width: 576px) {
        .empty-state-actions {
            flex-direction: row;
        }
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        
        .guide-title {
            font-size: 1.3rem;
        }
    }
    
    @media (max-width: 576px) {
        .stats-number {
            font-size: 2rem;
        }
        
        .guide-meta {
            gap: 0.5rem;
        }
        
        .guide-meta-item {
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div style="text-align: center; margin-bottom: 2rem;">
    <h1 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 0.5rem;">é‡å­å¤ªç©ºæ€æ”»ç•¥ç«™</h1>
    <p style="color: rgba(255, 255, 255, 0.9);">å‘ç°æœ€æ–°ã€æœ€å…¨é¢çš„æ¸¸æˆæ”»ç•¥å’Œæˆ˜æœ¯æŒ‡å—</p>
</div>

<!-- æœç´¢æ  -->
<div class="search-container">
    <form method="get" class="search-form" id="searchForm">
        <div class="search-input-group">
            <div class="search-input">
                <span class="search-icon">ğŸ”</span>
                <input type="text" 
                       name="q" 
                       id="search" 
                       class="form-control" 
                       placeholder="æœç´¢æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…..."
                       value="{{ search_query }}">
            </div>
            <div class="form-group">
                <select name="sort" id="sort" class="form-control">
                    <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>æœ€æ–°å‘å¸ƒ</option>
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>æœ€æ—©å‘å¸ƒ</option>
                    <option value="title" {% if sort_by == 'title' %}selected{% endif %}>æ ‡é¢˜å‡åº</option>
                    <option value="-title" {% if sort_by == '-title' %}selected{% endif %}>æ ‡é¢˜é™åº</option>
                </select>
            </div>
        </div>
        <div class="search-buttons">
            <button type="submit" class="btn btn-primary search-btn">
                <span>ğŸ” æœç´¢</span>
            </button>
            {% if search_query %}
                <a href="{% url 'guides:home' %}" class="btn btn-secondary reset-btn">
                    <span>ğŸ”„ é‡ç½®</span>
                </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- åˆ†ç±»ç­›é€‰ -->
<div class="category-filter">
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}" 
       class="category-btn {% if not request.GET.category %}active{% endif %}">
        å…¨éƒ¨
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}category=strategy" 
       class="category-btn {% if request.GET.category == 'strategy' %}active{% endif %}">
        æˆ˜æœ¯ç­–ç•¥
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}category=guide" 
       class="category-btn {% if request.GET.category == 'guide' %}active{% endif %}">
        æ–°æ‰‹æŒ‡å—
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}category=advanced" 
       class="category-btn {% if request.GET.category == 'advanced' %}active{% endif %}">
        é«˜çº§æŠ€å·§
    </a>
    <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}category=discussion" 
       class="category-btn {% if request.GET.category == 'discussion' %}active{% endif %}">
        è®¨è®ºäº¤æµ
    </a>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="stats-container">
    <div class="stats-card">
        <div class="stats-number">{{ total_guides }}</div>
        <div class="stats-label">æ€»æ”»ç•¥æ•°</div>
    </div>
    <div class="stats-card" style="background: linear-gradient(135deg, var(--success-color), #2ecc71);">
        <div class="stats-number">{{ active_users }}</div>
        <div class="stats-label">æ´»è·ƒç”¨æˆ·</div>
    </div>
    <div class="stats-card" style="background: linear-gradient(135deg, var(--warning-color), #f1c40f);">
        <div class="stats-number">{{ page_obj|length }}</div>
        <div class="stats-label">å½“å‰é¡µæ”»ç•¥</div>
    </div>
</div>

<!-- èŠå¤©å®¤åŠŸèƒ½ä»‹ç» -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--border-radius); padding: 2rem; margin-bottom: 2rem; color: white; animation: fadeIn 0.8s ease-out; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);">
    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’¬</div>
        <h2 style="margin-top: 0; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">å…¨æ–°èŠå¤©å®¤åŠŸèƒ½</h2>
        <p style="margin-bottom: 1.5rem; max-width: 600px; opacity: 0.9;">ä¸å…¶ä»–é‡å­æŒ‡æŒ¥å®˜å®æ—¶äº¤æµæˆ˜æœ¯ã€åˆ†äº«ç»éªŒã€ç»„é˜Ÿå¼€é»‘ï¼åˆ›å»ºä¸“å±æˆ¿é—´æˆ–åŠ å…¥å…¬å¼€è®¨è®ºï¼Œè®©ä½ çš„æ¸¸æˆä½“éªŒæ›´åŠ ä¸°å¯Œã€‚</p>
        {% if user.is_authenticated %}
            <a href="{% url 'guides:chat_room' %}" class="btn btn-light btn-lg" style="padding: 0.75rem 2rem; font-weight: bold; text-decoration: none; border-radius: 50px; transition: all 0.3s ease;">
                ç«‹å³è¿›å…¥èŠå¤©å®¤ â†’
            </a>
        {% else %}
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <a href="{% url 'guides:login' %}" class="btn btn-light" style="padding: 0.75rem 1.5rem; font-weight: bold; text-decoration: none; border-radius: 50px; transition: all 0.3s ease;">
                    ç™»å½•åä½“éªŒ
                </a>
                <a href="{% url 'guides:register' %}" class="btn btn-dark" style="padding: 0.75rem 1.5rem; font-weight: bold; text-decoration: none; border-radius: 50px; transition: all 0.3s ease;">
                    æ³¨å†Œæ–°è´¦å·
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- æ”»ç•¥åˆ—è¡¨æ ‡é¢˜ -->
<h1 style="margin-bottom: 1.5rem; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
    ğŸ”¥ çƒ­é—¨æ”»ç•¥
</h1>

{% if page_obj %}
    <div class="guide-list">
        {% for guide in page_obj %}
        <div class="guide-card">
            <h2 class="guide-title">
                <a href="{{ guide.get_absolute_url }}">{{ guide.title }}</a>
            </h2>
            <div class="guide-meta">
                <span class="guide-meta-item">ğŸ‘¤ {{ guide.author.username }}</span>
                <span class="guide-meta-item">ğŸ“… {{ guide.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
                <span class="guide-meta-item">ğŸ‘ï¸ {{ guide.views }} æµè§ˆ</span>
                <span class="guide-meta-item">ğŸ·ï¸ {{ guide.get_category_display }}</span>
            </div>
            <div class="guide-content">
                {{ guide.content|truncatechars:200 }}
            </div>
            {% if guide.get_tags_list %}
                <div class="guide-tags">
                    {% for tag in guide.get_tags_list %}
                        <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}tag={{ tag }}" class="tag">{{ tag }}</a>
                    {% endfor %}
                </div>
            {% endif %}
            <div style="margin-top: 1rem;">
                <a href="{{ guide.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                    é˜…è¯»å…¨æ–‡ â†’
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- åˆ†é¡µ -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ page_obj.previous_page_number }}" 
               class="btn" aria-label="ä¸Šä¸€é¡µ">
                â†
            </a>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <span class="btn active">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ num }}" 
                   class="btn">{{ num }}</a>
            {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                <span class="btn">...</span>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}page={{ page_obj.next_page_number }}" 
               class="btn" aria-label="ä¸‹ä¸€é¡µ">
                â†’
            </a>
        {% endif %}
    </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <h2 class="empty-state-title">æš‚æ— æ”»ç•¥</h2>
        <p>æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«æ”»ç•¥çš„é‡å­æŒ‡æŒ¥å®˜å§ï¼</p>
        
        {% if user.is_authenticated %}
            <div class="empty-state-actions">
                <a href="{% url 'guides:add_guide' %}" class="btn btn-primary btn-lg">
                    âœï¸ å‘å¸ƒç¬¬ä¸€æ¡æ”»ç•¥
                </a>
            </div>
        {% else %}
            <div class="empty-state-actions">
                <a href="{% url 'guides:login' %}" class="btn btn-primary">
                    ğŸ” ç™»å½•åå‘å¸ƒæ”»ç•¥
                </a>
                <a href="{% url 'guides:register' %}" class="btn btn-success">
                    ğŸš€ æ³¨å†Œæ–°è´¦å·
                </a>
            </div>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // æœç´¢è¡¨å•äº¤äº’ä¼˜åŒ–
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        const searchBtn = this.querySelector('.search-btn');
        const originalText = searchBtn.innerHTML;
        
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="loading"></div> æœç´¢ä¸­...';
        
        // è¡¨å•éªŒè¯
        const searchInput = this.querySelector('input[name="q"]');
        if (!searchInput.value.trim() && !this.querySelector('select[name="sort"]').value) {
            e.preventDefault();
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalText;
            alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯æˆ–é€‰æ‹©æ’åºæ–¹å¼');
            return;
        }
    });
    
    // æ”»ç•¥å¡ç‰‡æ‚¬åœåŠ¨ç”»
    document.querySelectorAll('.guide-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.15)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.1)';
        });
    });
    
    // ç»Ÿè®¡å¡ç‰‡è„‰å†²åŠ¨ç”»
    document.querySelectorAll('.stats-card').forEach((card, index) => {
        setTimeout(() => {
            card.style.animation = 'pulse 2s ease infinite';
        }, index * 300);
    });
    
    // åˆ†ç±»æŒ‰é’®äº¤äº’
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
    
    // æœç´¢è¾“å…¥è‡ªåŠ¨å®Œæˆ
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', function() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨å®Œæˆé€»è¾‘
        const value = this.value.trim();
        if (value.length > 2) {
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            const searchIcon = this.parentElement.querySelector('.search-icon');
            searchIcon.textContent = 'â³';
            
            // æ¨¡æ‹Ÿæœç´¢å»¶è¿Ÿ
            setTimeout(() => {
                searchIcon.textContent = 'ğŸ”';
            }, 500);
        }
    });
    
    // å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
</script>
{% endblock %}